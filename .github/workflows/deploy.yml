name: Deploy OpenClaw Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            echo "=== Deploying OpenClaw Server ==="

            # Update admin panel code
            cd /opt/openclaw-admin
            sudo git pull
            cd admin-panel
            sudo npm install --production
            echo "[+] Admin panel updated"

            # Restart admin panel
            sudo systemctl restart openclaw-admin
            sleep 3
            sudo systemctl status openclaw-admin --no-pager || true
            echo "[+] Admin panel restarted"

            # Restart openclaw-gateway if running (user service)
            export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus
            export XDG_RUNTIME_DIR=/run/user/$(id -u)
            systemctl --user restart openclaw-gateway 2>/dev/null || true
            echo "[+] OpenClaw gateway restart attempted"

            # Verify
            echo "=== Verification ==="
            curl -s -o /dev/null -w "Admin Panel: HTTP %{http_code}\n" http://localhost:3000/login
            curl -s -o /dev/null -w "Nginx:       HTTP %{http_code}\n" http://localhost/

            echo "=== Deploy Complete ==="
